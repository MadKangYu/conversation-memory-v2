%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#4A90D9'}}}%%

sequenceDiagram
    autonumber
    participant U as ğŸ‘¤ ì‚¬ìš©ì
    participant O as ğŸ¼ ì˜¤ì¼€ìŠ¤íŠ¸ë¼<br/>(Claude Code)
    participant M as ğŸ”Œ MCP
    participant A as ğŸ¤– ì—ì´ì „íŠ¸<br/>(Memory V2)
    participant L as ğŸ§  LLM<br/>(OpenRouter)
    participant D as ğŸ’¾ SQLite

    Note over U,D: ğŸ“ Phase 1: ëŒ€í™” ì‹œì‘ ë° ë©”ì‹œì§€ ì €ì¥

    U->>O: í”„ë¡œì íŠ¸ ì‘ì—… ì‹œì‘
    O->>M: memory_start_conversation()
    M->>A: ìƒˆ ëŒ€í™” ìƒì„±
    A->>D: INSERT conversation
    A-->>M: { conversationId: "conv_xxx" }
    M-->>O: ëŒ€í™” ID ë°˜í™˜

    loop ëŒ€í™” ì§„í–‰ (ë§¤ í„´ë§ˆë‹¤)
        U->>O: ì§ˆë¬¸/ìš”ì²­
        O->>M: memory_add_message(user, "ì§ˆë¬¸")
        M->>A: ë©”ì‹œì§€ ì €ì¥
        A->>A: Chunker: 500í† í° ë¶„í• 
        A->>D: INSERT message, chunk
        
        Note over A,L: ë°±ê·¸ë¼ìš´ë“œ ë¹„ë™ê¸° ìš”ì•½
        A--)L: ì²­í¬ ìš”ì•½ ìš”ì²­ (async)
        L--)A: JSON ìš”ì•½ ë°˜í™˜
        A--)D: UPDATE chunk.summary
        
        A-->>M: { messageId, tokens }
        M-->>O: ì €ì¥ ì™„ë£Œ
        
        O->>U: AI ì‘ë‹µ
        O->>M: memory_add_message(assistant, "ì‘ë‹µ")
        M->>A: ì‘ë‹µ ì €ì¥
        A->>D: INSERT message
    end

    Note over U,D: ğŸ“ Phase 2: ì••ì¶• íŠ¸ë¦¬ê±° (50K í† í° ë„ë‹¬ ì‹œ)

    O->>M: memory_should_compress()
    M->>A: ì••ì¶• í•„ìš” ì—¬ë¶€ í™•ì¸
    A->>D: SELECT SUM(tokens)
    D-->>A: currentTokens: 52000
    A-->>M: { shouldCompress: true, currentTokens: 52000 }
    M-->>O: ì••ì¶• í•„ìš”!

    O->>M: memory_get_context()
    M->>A: ì••ì¶• ì»¨í…ìŠ¤íŠ¸ ìš”ì²­
    
    Note over A,D: ê³„ì¸µì  ë³‘í•© ì‹¤í–‰
    A->>D: SELECT summaries
    A->>A: Merger: ê¸°ê³„ì  ë³‘í•©
    A->>A: Level 1 â†’ Level 2 â†’ Level 3
    A-->>M: { compressedContext, tokens: 5200 }
    M-->>O: ì••ì¶•ëœ ì»¨í…ìŠ¤íŠ¸ (5.2K í† í°)

    Note over O: ê¸°ì¡´ ëŒ€í™” ì‚­ì œ, ì••ì¶• ì»¨í…ìŠ¤íŠ¸ë¡œ êµì²´
    O->>O: ì»¨í…ìŠ¤íŠ¸ ìœˆë„ìš° ê°±ì‹ 

    Note over U,D: ğŸ“ Phase 3: ê²€ìƒ‰ ë° ì¡°íšŒ

    U->>O: "ì§€ë‚œë²ˆ ê²°ì œ ì—°ë™ ì–´ë–»ê²Œ í–ˆì§€?"
    O->>M: memory_search("ê²°ì œ ì—°ë™")
    M->>A: FTS5 ê²€ìƒ‰
    A->>D: SELECT ... MATCH 'ê²°ì œ ì—°ë™'
    D-->>A: ê²€ìƒ‰ ê²°ê³¼ (í•˜ì´ë¼ì´íŒ…)
    A-->>M: [{ snippet: "...ê²°ì œ ì—°ë™...", score: 0.95 }]
    M-->>O: ê²€ìƒ‰ ê²°ê³¼ ë°˜í™˜
    O->>U: "ì§€ë‚œë²ˆì— Stripe APIë¡œ ê²°ì œ ì—°ë™í–ˆìŠµë‹ˆë‹¤..."

    Note over U,D: ğŸ“ Phase 4: ì„¸ì…˜ ì¢…ë£Œ ë° ì¬ê°œ

    U->>O: ì‘ì—… ì¢…ë£Œ
    O->>M: memory_auto_save()
    M->>A: ìµœì¢… ìƒíƒœ ì €ì¥
    A->>D: UPDATE conversation.state
    A-->>M: { saved: true }

    Note over U,D: â° ë‹¤ìŒ ë‚ ...

    U->>O: í”„ë¡œì íŠ¸ ì¬ê°œ
    O->>M: memory_get_context()
    M->>A: ì´ì „ ì»¨í…ìŠ¤íŠ¸ ë¡œë“œ
    A->>D: SELECT compressed_context
    A-->>M: { context: "ì–´ì œê¹Œì§€ì˜ ì§„í–‰ìƒí™©..." }
    M-->>O: ì»¨í…ìŠ¤íŠ¸ ë³µì›
    O->>U: "ì–´ì œ Stripe ê²°ì œ ì—°ë™ê¹Œì§€ ì™„ë£Œí–ˆìŠµë‹ˆë‹¤. ì´ì–´ì„œ ì§„í–‰í• ê¹Œìš”?"
