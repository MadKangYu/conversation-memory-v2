%%{init: {'theme': 'base', 'themeVariables': { 'primaryColor': '#4A90D9', 'primaryTextColor': '#fff', 'primaryBorderColor': '#2E5A8B', 'lineColor': '#5C6BC0', 'secondaryColor': '#81C784', 'tertiaryColor': '#FFB74D'}}}%%

flowchart TB
    subgraph USER["ğŸ‘¤ ì‚¬ìš©ì (User)"]
        U1["í„°ë¯¸ë„ / IDE"]
    end

    subgraph ORCHESTRATOR["ğŸ¼ ì˜¤ì¼€ìŠ¤íŠ¸ë¼ (Orchestrator)"]
        direction TB
        O1["Claude Code / OpenCode / Cursor"]
        O2["System Prompt / CLAUDE.md"]
        O3["ì»¨í…ìŠ¤íŠ¸ ìœˆë„ìš°<br/>(200K í† í° í•œê³„)"]
        
        O1 --> O2
        O2 --> O3
    end

    subgraph MCP["ğŸ”Œ MCP í”„ë¡œí† ì½œ (Model Context Protocol)"]
        direction LR
        M1["JSON-RPC 2.0"]
        M2["ë„êµ¬ í˜¸ì¶œ<br/>(Tool Call)"]
        M3["ë¦¬ì†ŒìŠ¤ ì¡°íšŒ<br/>(Resource)"]
        
        M1 --> M2
        M1 --> M3
    end

    subgraph AGENT["ğŸ¤– ì—ì´ì „íŠ¸ (Conversation Memory V2)"]
        direction TB
        
        subgraph CORE["í•µì‹¬ ëª¨ë“ˆ"]
            A1["Chunker<br/>(500í† í° ë¶„í• )"]
            A2["Summarizer<br/>(LLM ìš”ì•½)"]
            A3["Merger<br/>(ê¸°ê³„ì  ë³‘í•©)"]
            A4["Indexer<br/>(íƒœê·¸ ì¶”ì¶œ)"]
        end
        
        subgraph STORAGE["ì €ì¥ì†Œ"]
            S1["SQLite + FTS5<br/>(ì „ë¬¸ ê²€ìƒ‰)"]
            S2["Cache Manager<br/>(LRU ìºì‹œ)"]
        end
        
        subgraph PROVIDERS["í”„ë¡œë°”ì´ë”"]
            P1["LLM Provider<br/>(OpenRouter)"]
            P2["Image Processor<br/>(Vision API)"]
        end
        
        A1 --> A2
        A2 --> A3
        A3 --> A4
        A4 --> S1
        A2 --> P1
        S1 --> S2
    end

    subgraph CLI["âŒ¨ï¸ CLI (Command Line Interface)"]
        direction LR
        C1["conv-memory serve"]
        C2["conv-memory start"]
        C3["conv-memory add"]
        C4["conv-memory context"]
        C5["conv-memory search"]
    end

    subgraph TOOLS["ğŸ”§ MCP ë„êµ¬ ëª©ë¡"]
        direction TB
        T1["memory_should_compress<br/>ì••ì¶• í•„ìš” ì—¬ë¶€ í™•ì¸"]
        T2["memory_get_context<br/>ì••ì¶•ëœ ì»¨í…ìŠ¤íŠ¸ ì¡°íšŒ"]
        T3["memory_add_message<br/>ë©”ì‹œì§€ ì €ì¥"]
        T4["memory_search<br/>ëŒ€í™” ê¸°ë¡ ê²€ìƒ‰"]
        T5["memory_auto_save<br/>ìë™ ì €ì¥"]
    end

    %% ì—°ê²°ì„ 
    U1 <--> O1
    U1 <--> C1
    
    O1 <-->|"MCP Protocol"| MCP
    MCP <-->|"JSON-RPC"| AGENT
    
    C1 -->|"ì„œë²„ ì‹œì‘"| AGENT
    C2 -->|"ëŒ€í™” ì‹œì‘"| AGENT
    C3 -->|"ë©”ì‹œì§€ ì¶”ê°€"| AGENT
    C4 -->|"ì»¨í…ìŠ¤íŠ¸ ì¡°íšŒ"| AGENT
    C5 -->|"ê²€ìƒ‰"| AGENT
    
    MCP --> TOOLS
    TOOLS --> AGENT

    %% ìŠ¤íƒ€ì¼
    classDef userStyle fill:#E3F2FD,stroke:#1565C0,stroke-width:2px
    classDef orchestratorStyle fill:#FFF3E0,stroke:#E65100,stroke-width:2px
    classDef mcpStyle fill:#E8F5E9,stroke:#2E7D32,stroke-width:2px
    classDef agentStyle fill:#F3E5F5,stroke:#7B1FA2,stroke-width:2px
    classDef cliStyle fill:#ECEFF1,stroke:#455A64,stroke-width:2px
    classDef toolsStyle fill:#E0F7FA,stroke:#00838F,stroke-width:2px
    
    class USER userStyle
    class ORCHESTRATOR orchestratorStyle
    class MCP mcpStyle
    class AGENT agentStyle
    class CLI cliStyle
    class TOOLS toolsStyle
